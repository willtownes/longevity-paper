---
title: "Predicting Pro vs Anti Longevity from Gene Expression"
author: "Will Townes"
date: "3/29/2018"
output: html_document
---

Using gene expression alone to predict pro vs anti longevity genes from genage database.

```{r}
#library(doParallel)
#registerDoParallel(makeCluster(detectCores()-1)) #3 cores on mac
source("./util.R") #loads caret, ROCR
spp<-c("yeast","worm")
sp<-spp[2]
features<-c("archs4","other1")
fts<-features[1]
```

## Data Loading

```{r}
dat<-readRDS(paste0("./data/auto/",sp,".rds"))
y<-rep("anti",length(dat$y))
y[dat$y==1]<-"pro"
y<-factor(y)
ytrn<-y[dat$train_idx]
ytst<-y[-dat$train_idx]
X<-dat[[fts]]
Xtrn<-X[dat$train_idx,]
Xtst<-X[-dat$train_idx,]
```

knn classifier

```{r}
fit<-knn(Xtrn,Xtst,ytrn,k=10,prob=TRUE)
probs<-attr(fit,"prob")
probs[fit=="anti"]<-1-probs[fit=="anti"]
preds<-prediction(probs,ytst)
auc.tmp<-performance(preds,"auc")
(auc<-as.numeric(auc.tmp@y.values))

fit<-kknn(y~.,data.frame(y=ytrn,Xtrn),data.frame(y=ytst,Xtst),k=20)
probs<-predict(fit,type="prob")[,2]
performance(prediction(probs,ytst),"auc")

#knn via caret
system.time(fit<-train(Xtrn, ytrn, preProcess=NULL, metric="Kappa", trControl=trainControl("repeatedcv",5,repeats=2),  method="kknn"))
#tuneGrid=expand.grid(kmax=c(5,10,15),distance=c(1,2),kernel="optimal")
print(fit)
perf<-caret_roc(fit,Xtst,ytst,ytrn)
ggplot(perf,aes(x=fpr,y=tpr,col=fold))+geom_line()+theme_bw()+geom_abline(slope=1,intercept=0,alpha=.5)
roc2auc(perf$fpr[perf$fold=="test"],perf$tpr[perf$fold=="test"])
```

xgboost

```{r}
system.time(fit<-train(Xtrn, ytrn, preProcess=NULL, metric="Kappa", trControl=trainControl("repeatedcv",5,repeats=2),  method="xgbTree"))
print(fit)
perf<-caret_roc(fit,Xtst,ytst,ytrn)
ggplot(perf,aes(x=fpr,y=tpr,col=fold))+geom_line()+theme_bw()+geom_abline(slope=1,intercept=0,alpha=.5)
roc2auc(perf$fpr[perf$fold=="test"],perf$tpr[perf$fold=="test"])
```

svm with caret
```{r}
system.time(fit<-train(Xtrn, ytrn, preProcess=NULL, metric="Kappa", trControl=trainControl("repeatedcv",5,repeats=2),  method="svmRadialSigma", prob.model=TRUE))
print(fit)
perf<-caret_roc(fit,Xtst,ytst,ytrn)
ggplot(perf,aes(x=fpr,y=tpr,col=fold))+geom_line()+theme_bw()+geom_abline(slope=1,intercept=0,alpha=.5)
roc2auc(perf$fpr[perf$fold=="test"],perf$tpr[perf$fold=="test"])
```

GLMnet prediction

```{r}
system.time(fit<-train(Xtrn, ytrn, preProcess=NULL, metric="Kappa", trControl=trainControl("repeatedcv",5,repeats=2),  method="glmnet", family="binomial"))
print(fit)
perf<-caret_roc(fit,Xtst,ytst,ytrn)
ggplot(perf,aes(x=fpr,y=tpr,col=fold))+geom_line()+theme_bw()+geom_abline(slope=1,intercept=0,alpha=.5)
roc2auc(perf$fpr[perf$fold=="test"],perf$tpr[perf$fold=="test"])
```
