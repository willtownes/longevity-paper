---
title: "Make Graphs Summarizing AUC Patterns"
author: "Will Townes"
date: "10/11/2018"
output: html_document
---

```{r}
library(tidyverse)
theme_set(theme_bw())
source("./carets.R")
sp<-TRUE #save plots?
fp<-file.path
bp<-"./results/auto"
pth<-fp(bp,"plots")
if(!dir.exists(pth)){
  dir.create(pth,recursive=TRUE)
}
ggs<-function(plt,w=6,h=4){
  if(sp){ ggsave(file=fp(pth,plt),width=w,height=h) }
}
```

Get list of hyperparameters for each algorithm

```{r}
x<-readRDS(fp(bp,"yeast/go/carets1.rds"))
res<-lapply(x,function(t){t$results[,1:(ncol(t$results)-4)]})
y<-readRDS(fp(bp,"worm/archs4/carets2.rds"))
res2<-lapply(y,function(t){t$results[,1:(ncol(t$results)-4)]})
res_tree<-lapply(res$xgbTree,unique)
res2_tree<-lapply(res$xgbTree,unique)
```

```{r}
#load all ROC results
species<-c("worm","yeast")
fts<-c("go","archs4","gxp","go_archs4","go_gxp")
atlas<-expand.grid(features=fts,species=species,cv_folds=1:5,stringsAsFactors=FALSE)
load_data<-function(sp,ft,fld){
  pth<-file.path(bp,sp,ft,paste0("roc",fld,".txt"))
  d<-read.table(pth,header=TRUE)
  d$species<-sp
  d$features<-ft
  d$cv_fold<-fld
  d
}
pd<-do.call(rbind,mapply(load_data,atlas$species,atlas$features,atlas$cv_folds,SIMPLIFY=FALSE))
rownames(pd)<-NULL
auc0<-pd %>% group_by(species,features,alg,fold,cv_fold) %>% summarize(auc=roc2auc(fpr,tpr))
auc0$alg<-plyr::mapvalues(auc0$alg,from=c("glmnet","svmRadialSigma","xgbTree","naive_bayes","kknn"),to=c("pglm","svm","xgb","nb","knn"))
colnames(auc0)[colnames(auc0)=="alg"]<-"algorithms"
auc<-subset(auc0,fold=="test")
auc$features<-factor(auc$features,levels=c("archs4","gxp","go","go_archs4","go_gxp"),ordered=TRUE)
```

pairwise comparison of all algorithms. Focusing only on test set AUC, for each combination of species, features set, and cross validation fold, rank the algorithms according to their AUC. Then, for each pairwise comparison of algorithms, compute the fraction of folds where one algorithm was superior to the other. Order the algorithms by the minimum of these proportions. The idea is that a consistently good algorithm is better than all other algorithms uniformly.

```{r}
algs<-levels(auc$algorithms)
pc<-spread(auc,algorithms,auc)
rk<-t(apply(pc[,algs],1,rank))
pc2<-matrix(0,nrow=length(algs),ncol=length(algs))
rownames(pc2)<-colnames(pc2)<-algs
for(i in seq_along(algs)){
  for(j in seq_along(algs)){
    #fraction of folds where 'i' was better than 'j'
    pc2[i,j]<-mean(rk[,i]>rk[,j])
  }
}
o<-order(apply(pc2,1,function(t){min(t[t>0])}),decreasing=TRUE)
pc2<-pc2[o,o]
print(pc2)
write.table(pc2,file="./results/auto/alg_table.txt",quote=FALSE)

#order levels of algs factor based on performance
auc$algorithms<-factor(auc$algorithms,levels=rev(rownames(pc2)),ordered=TRUE)
```

overall summary of all results

```{r}
cbb<-c("#E69F00","#56B4E9","#009E73","#0072B2","#D55E00","#CC79A7","#F0E442","#000000")
ggplot(auc,aes(x=algorithms,y=auc,fill=features,colour=features))+geom_boxplot()+facet_wrap(~species)+scale_fill_manual(values=cbb)+scale_colour_manual(values=cbb)+ylab("area under ROC")#+theme(axis.text.x=element_text(angle = 30, hjust = 1))
ggs("auc_all_xalg.pdf")
ggplot(auc,aes(x=features,y=auc,fill=algorithms,colour=algorithms))+geom_boxplot()+facet_wrap(~species)+scale_fill_manual(values=cbb)+scale_colour_manual(values=cbb)+ylab("area under ROC")+theme(axis.text.x=element_text(angle = 30, hjust = 1))
ggs("auc_all_xfeat.pdf")

#subset on best performing algorithms only
auc2<-subset(auc,algorithms %in% c("svm","pglm"))
auc2$algorithms<-factor(auc2$algorithms,levels=c("pglm","svm"))
ggplot(auc2,aes(x=features,y=auc,fill=algorithms,colour=algorithms))+geom_boxplot()+facet_wrap(~species)+scale_fill_manual(values=cbb[5:4])+scale_colour_manual(values=cbb[5:4])+ylab("area under ROC")+theme(axis.text.x=element_text(angle = 30, hjust = 1),legend.position="top")
ggs("auc_svm_pglm.pdf")
```
